workflows:
  android-full-featured:
    name: APK Pro - Carte + GPS + Photos
    environment:
      flutter: 3.41.1
    scripts:
      - name: Build APK
        script: |
          flutter clean
          flutter pub get
          flutter pub run flutter_launcher_icons:main
          flutter create --platforms android .
          mkdir -p android/app/src/main/res/xml
          echo '<?xml version="1.0"?><network-security-config><domain includeSubdomains="true">*.openstreetmap.org</domain></network-security-config>' > android/app/src/main/res/xml/network_security_config.xml
          awk '/<manifest/{print;print "  <uses-permission android:name="android.permission.INTERNET"/><uses-permission android:name="android.permission.ACCESS_NETWORK_STATE"/><uses-permission android:name="android.permission.ACCESS_FINE_LOCATION"/><uses-permission android:name="android.permission.ACCESS_COARSE_LOCATION"/><uses-permission android:name="android.permission.READ_EXTERNAL_STORAGE"/><uses-permission android:name="android.permission.READ_MEDIA_IMAGES"/><uses-permission android:name="android.permission.CAMERA"/>";gsub(/<application /,"<application android:networkSecurityConfig="@xml/network_security_config" ");print;next}1' android/app/src/main/AndroidManifest.xml>tmp&&mv tmp android/app/src/main/AndroidManifest.xml
          flutter build apk --debug
    artifacts:
      - build/app/outputs/flutter-apk/app-debug.apk